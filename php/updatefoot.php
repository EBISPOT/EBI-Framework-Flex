<?php/** * Extracts footer HTML from $master page * Writes footer HTML to $file *//* Copyright (c) EMBL-EBI 2013   Authors:    Peter Walter (pwalter@ebi.ac.uk)*/date_default_timezone_set('UTC');// url of html master page$master = "http://www.ebi.ac.uk/web_guidelines/html/compliance/index.html";// html tag and id of footer$htmltag = "nav";$htmlid = "global-nav-expanded";// output js file relative to this script$path = realpath(dirname(__FILE__) . '/../js');$file = $path . '/foot.js';// get master page$ch = curl_init($master);curl_setopt($ch, CURLOPT_HEADER, 0);curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);$page = curl_exec($ch);curl_close($ch);if ($page === FALSE) {  exit("Error fetching ${master}");}// find footerif (preg_match("#<${htmltag}[^>]*\s+id=[\"']${htmlid}[\"'][^>]*>(.*)</${htmltag}>#Uusm", $page, $matches) !== 1) {  exit("Error finding <${htmltag} id=\"{$htmlid}\">");}if (count($matches) < 1) {  exit("Error locating html in <${htmltag} id=\"{$htmlid}\">");}$foot = trim($matches[1]);$lines = explode("\n", $foot);// create footer js$output[] = "/* Copyright (c) EMBL-EBI 2013";$output[] = "   Authors:";$output[] = "   Peter Walter (pwalter@ebi.ac.uk)";$output[] = "*/";$output[] = "";$output[] = "// This file was autogenerated " . date('r') . " - do not edit";$output[] = "";$output[] = "(function updateFoot() {";$output[] = "  var html=''+";foreach ($lines as $line) {  $output[] = "    '" . preg_replace("#\s+#usm", ' ', str_replace("'", "\'", $line)) . "'+";}$output[] = "    '';";$output[] = "  function init() {";$output[] = "    try {";// update mega footer$output[] = "      var foot=document.getElementById('${htmlid}');foot.innerHTML=html;";$output[] = "    }"; // end try$output[] = "    catch(err) {"; // opera doesn't support script defer, so we need to wait until the dom is loaded$output[] = "      setTimeout(init,500);";$output[] = "    }"; // end catch$output[] = "  }";$output[] = "  init();";$output[] = "})();";$output[] = "";$output[] = "(function includeScripts() {";$output[] = "  var requireScripts = [";$output[] = "    '//www.ebi.ac.uk/web_guidelines/js/cookiebanner.js',";$output[] = "    '//www.ebi.ac.uk/web_guidelines/js/foot.js',"; // this script$output[] = "    '//www.ebi.ac.uk/web_guidelines/js/script.js',";$output[] = "    '//www.ebi.ac.uk/web_guidelines/js/responsify.js',";// $output[] = "    '//www.ebi.ac.uk/web_guidelines/js/survey.js?' + Math.round(new Date().getTime() / 3600000), // break cache every hour";$output[] = "    '//www.ebi.ac.uk/web_guidelines/js/downtime.js?' + Math.round(new Date().getTime() / 3600000) // break cache every hour";$output[] = "  ];";$output[] = "  function init() {";$output[] = "    try {";// attach script.js to foot of document$output[] = "      var existingScripts = document.getElementsByTagName('script');";$output[] = "      var gotScript, i, j, putScript;";$output[] = "      for (j = 0; j < requireScripts.length; j++) {";$output[] = "        for (gotScript = false, i = 0; i < existingScripts.length; i++)";$output[] = "          if (existingScripts[i].src.indexOf(requireScripts[j]) !== -1)";$output[] = "            gotScript = true;";$output[] = "        if (!gotScript) {";$output[] = "          putComment = document.createComment(requireScripts[j] + ' automatically inserted');";$output[] = "          putScript = document.createElement('script');";$output[] = "          putScript.type = 'text/javascript';";$output[] = "          putScript.src = requireScripts[j];";$output[] = "          document.body.appendChild(putComment);";$output[] = "          document.body.appendChild(putScript);";$output[] = "        }";$output[] = "      }";$output[] = "    }"; // end try$output[] = "    catch(err) {"; // opera doesn't support script defer, so we need to wait until the dom is loaded$output[] = "      setTimeout(init,500);";$output[] = "    }"; // end catch$output[] = "  }";$output[] = "  init();";$output[] = "})();";// write js file//if (file_put_contents($file, implode("\n", preg_replace("#\s+#usm", " ", $output))) === FALSE) {if (file_put_contents($file, implode("\n", $output)) === FALSE) {  exit("Error writing to ${file}");}